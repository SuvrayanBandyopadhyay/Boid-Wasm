<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Boids</title>
</head>
<body>
    <button onclick="addBoid()">Add a new boid</button>
    <button onclick="run()">Start Simulation</button>
    <canvas id="canvas" width="100vw" height="100vh" style="border:1px solid black"></canvas>
    <script src="boid.js"></script>
    <script>
        let running = false;
        const canvas = document.getElementById("canvas");
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        const ctx = canvas.getContext("2d");
        ctx.imageSmoothingQuality = "high";
        //Add a boid
        function addBoid()
        {
            Module._addBoid();
        }
        //Start the simulation
        function run()
        {
            if (running) return;
            running = true;
            requestAnimationFrame(loop);
        }
        //Main loop
        function loop()
        {
            if(!running) return;
            Module._run();
            drawBoids();
            requestAnimationFrame(loop);
        }
        //Function to draw boids on canvas
        function drawBoids()
        {
            const size = Module._getSize();
            if (size === 0) return;

            const xPtr = Module._getXPtr();
            const yPtr = Module._getYPtr()

            //Create the floating arrays
            const x = new Float32Array(Module.HEAPF32.buffer,xPtr,size);
            const y = new Float32Array(Module.HEAPF32.buffer,yPtr,size);

            ctx.fillStyle = "rgba(0,0,100,0.01)";
            ctx.fillRect(0,0,canvas.width,canvas.height);

            //Draw the partilces
            for(let i = 0;i<size;i++)
            {
                const sx = (x[i]+1.0)/2.0*canvas.width;
                const sy = (y[i]+1.0)/2.0*canvas.height;
                
                ctx.fillStyle = "blue";
                ctx.beginPath();
                ctx.arc(sx,sy,8.0,0,Math.PI*2);
                ctx.fill();
            }
        }
        Module.onRuntimeInitialized = () =>
        {
            Module._init(1000);
            ctx.fillStyle = "rgba(0,0,100,0.1)";
            ctx.fillRect(0,0,canvas.width,canvas.height);
        };
    </script>
</body>
